// ==UserScript==
// @name         Temu - Mass Helper
// @namespace    https://hapidecor-tools
// @version      1.3
// @description  List: Tá»± Ä‘á»™ng highlight vÃ  Ä‘áº¿m sá»‘ lÆ°á»£ng trÆ°á»›c khi báº¥m Start. Detail: Auto Apply -> Publish -> Close.
// @match        *://seller.temu.com/*
// @run-at       document-idle
// @grant        window.close
// ==/UserScript==

(function () {
    'use strict';

    const LABEL_TEXT = 'Custom info required';
    const WAIT_BEFORE_CLOSE = 3000;
    const BTN_ID = 'tm-start-btn-v13'; // ID Ä‘á»ƒ Ä‘á»‹nh danh nÃºt

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // =================================================================
    // PHáº¦N 0: HÃ€M TOAST (ThÃ´ng bÃ¡o Ä‘áº¹p)
    // =================================================================
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.textContent = message;
        Object.assign(toast.style, {
            position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
            backgroundColor: type === 'error' ? '#d32f2f' : '#2e7d32',
            color: '#fff', padding: '12px 24px', borderRadius: '8px',
            zIndex: '1000000', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
            fontSize: '15px', fontWeight: '500', opacity: '0', transition: 'opacity 0.3s', pointerEvents: 'none'
        });
        document.body.appendChild(toast);
        requestAnimationFrame(() => toast.style.opacity = '1');
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => { if (document.body.contains(toast)) document.body.removeChild(toast); }, 300);
        }, 3000);
    }

    // =================================================================
    // PHáº¦N 1: LIST PAGE (Logic Má»›i)
    // =================================================================

    // 1. HÃ m tÃ¬m cÃ¡c badges chÆ°a xá»­ lÃ½
    function findCustomBadges() {
        const allDivs = Array.from(document.querySelectorAll('div, a'));
        let badges = allDivs.filter((d) => d.textContent.trim() === LABEL_TEXT);
        // Chá»‰ láº¥y nhá»¯ng cÃ¡i chÆ°a Ä‘Æ°á»£c má»Ÿ (dataset.tmOpened chÆ°a cÃ³) vÃ  Ä‘ang hiá»ƒn thá»‹
        badges = badges.filter((b) => !b.dataset.tmOpened && b.offsetParent !== null);
        return badges;
    }

    // 2. HÃ m Highlight vÃ  cáº­p nháº­t sá»‘ lÆ°á»£ng lÃªn nÃºt (Cháº¡y liÃªn tá»¥c)
    function scanAndHighlightUI() {
        const badges = findCustomBadges();
        const btn = document.getElementById(BTN_ID);

        // Highlight ngay láº­p tá»©c
        badges.forEach(badge => {
            const row = badge.closest('tr');
            // Náº¿u chÆ°a tÃ´ mÃ u thÃ¬ tÃ´ ngay
            if (row && row.style.outlineColor !== 'orange') {
                row.style.outline = '2px solid orange';
                row.style.transition = 'outline 0.3s';
            }
        });

        // Cáº­p nháº­t text cho nÃºt
        if (btn) {
            if (badges.length > 0) {
                btn.textContent = `ðŸš€ START (${badges.length / 2} items)`;
                btn.style.background = '#d32f2f'; // MÃ u Ä‘á» khi cÃ³ hÃ ng
            } 
        }
    }

    // 3. HÃ m táº¡o nÃºt (chá»‰ cháº¡y 1 láº§n Ä‘áº§u hoáº·c khi nÃºt bá»‹ máº¥t)
    function createStartButtonForList() {
        if (document.getElementById(BTN_ID)) return; // Náº¿u cÃ³ rá»“i thÃ¬ thÃ´i

        const btn = document.createElement('button');
        btn.id = BTN_ID;
        btn.textContent = 'ðŸš€ START (Scanning...)';
        Object.assign(btn.style, {
            position: 'fixed', right: '20px', top: '70px', zIndex: 999999,
            padding: '10px 16px', background: '#777', color: '#fff',
            border: 'none', borderRadius: '4px', cursor: 'pointer',
            fontSize: '14px', fontWeight: 'bold', boxShadow: '0 2px 6px rgba(0,0,0,0.3)',
            minWidth: '160px'
        });

        btn.addEventListener('click', () => {
            processScanClick();
        });

        document.body.appendChild(btn);
    }

    // 4. HÃ m xá»­ lÃ½ khi báº¥m nÃºt Start
    function processScanClick() {
        const badges = findCustomBadges();
        if (badges.length === 0) {
            showToast('âš ï¸ Hiá»‡n táº¡i khÃ´ng cÃ³ sáº£n pháº©m nÃ o cáº§n xá»­ lÃ½!', 'error');
            return;
        }

        showToast(`âœ… Báº¯t Ä‘áº§u má»Ÿ ${badges.length /2} tabs...`, 'success');

        badges.forEach((badge, index) => {
            // ÄÃ¡nh dáº¥u Ä‘Ã£ má»Ÿ Ä‘á»ƒ láº§n scan sau khÃ´ng Ä‘áº¿m ná»¯a
            badge.dataset.tmOpened = '1';

            // Äá»•i mÃ u row sang xanh dÆ°Æ¡ng Ä‘á»ƒ biáº¿t lÃ  "Äang xá»­ lÃ½"
            const row = badge.closest('tr');
            if (row) row.style.outline = '2px solid #2196f3';

            setTimeout(() => {
                if (badge.tagName === 'DIV') {
                    const parentLink = badge.closest('a');
                    if (parentLink) parentLink.click();
                    else badge.click();
                } else {
                    badge.click();
                }
            }, index * 1500);
        });
    }

    // 5. Init trang List: Cháº¡y láº·p liÃªn tá»¥c Ä‘á»ƒ update UI
    function initProductsPageHelper() {
        // Loop má»—i 1 giÃ¢y: Táº¡o nÃºt náº¿u thiáº¿u + Scan highlight + Update sá»‘ Ä‘áº¿m
        setInterval(() => {
            if (document.body) {
                createStartButtonForList();
                scanAndHighlightUI();
            }
        }, 1000);
    }

    // =================================================================
    // PHáº¦N 2: DETAIL PAGE (GIá»® NGUYÃŠN NHÆ¯ V1.2)
    // =================================================================

    async function autoRunDetailTask() {
        console.log('[TM Detail] Tab open. Waiting for variants...');
        let variants = [];
        for (let i = 0; i < 30; i++) {
            variants = document.querySelectorAll('div[class*="skcList"] div[class*="skcItem"]');
            if (variants.length > 0) break;
            await sleep(1000);
        }

        if (variants.length === 0) {
            console.warn('[TM Detail] Timeout: No variants found.');
            return;
        }

        for (let i = 0; i < variants.length; i++) {
            variants[i].click();
            await sleep(1500);
            const success = await clickImportButtonByXPath();
            if (!success) console.warn(`[TM Detail] Variant ${i+1}: KhÃ´ng tÃ¬m tháº¥y nÃºt Import!`);
        }

        const publishBtn = findPublishButton();
        if (publishBtn) {
            publishBtn.click();
            await sleep(1500);
            clickConfirmPopup();
            await sleep(WAIT_BEFORE_CLOSE);
            window.close();
        }
    }

    async function clickImportButtonByXPath() {
        const xpath = "//div[contains(text(), 'Import customization template')]/ancestor::div[@role='button' or contains(@class, 'btn-')]";
        const xpathFallback = "//div[contains(text(), 'Import customization template')]";
        let result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        if (!result) result = document.evaluate(xpathFallback, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;

        if (result) {
            result.click();
            await sleep(1000);
            const dropdowns = document.querySelectorAll('body div.PT_dropdown_123, body ul.PT_menu-list_123');
            let lastDropdown = dropdowns[dropdowns.length - 1];
            if (!lastDropdown) {
                const allUls = document.querySelectorAll('body > div > ul, body > div > div > ul');
                if (allUls.length > 0) lastDropdown = allUls[allUls.length - 1];
            }
            if (lastDropdown) {
                const option = lastDropdown.querySelector('li') || lastDropdown.querySelector('div[role="option"]');
                if (option) {
                    option.click();
                    await sleep(2500);
                    return true;
                }
            }
            return true;
        }
        return false;
    }

    function findPublishButton() {
        return document.querySelector('#mms-layout-content div.btnWrapper-3is1W div:nth-child(2) div.btn-3yOxL.primary-2pgGm.medium-Hwmr9') ||
               Array.from(document.querySelectorAll('button, div')).find(el => el.textContent.trim() === 'Publish');
    }

    function clickConfirmPopup() {
        const confirmBtn = Array.from(document.querySelectorAll('body div[class*="modal"] button, body div[class*="modal"] div'))
                                .find(el => ['Confirm', 'OK'].includes(el.textContent.trim()));
        if (confirmBtn) confirmBtn.click();
    }

    function router() {
        const path = location.pathname;
        if (path.includes('/products')) {
            initProductsPageHelper();
            return;
        }
        if (document.title.includes('Custom product') || path.includes('/goods/custom/')) {
             setTimeout(autoRunDetailTask, 1500);
        } else {
            const checkTitle = setInterval(() => {
                if (document.title.includes('Custom product') || document.querySelector('#mms-layout-content form')) {
                    clearInterval(checkTitle);
                    autoRunDetailTask();
                }
            }, 1000);
        }
    }

    router();
})();
